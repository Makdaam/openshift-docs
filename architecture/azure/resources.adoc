[[architecture-azure-resources]]
= Resources
{product-author}
{product-version}
:data-uri:
:icons:
:experimental:
:toc: macro
:toc-title:
:prewrap!:

toc::[]

This section describes Azure resources that are used to build clusters.

[[virtual-machine-scale-sets]]
== Virtual machine scale sets

[discrete]
=== ss-masters
A scale set of three virtual machines that is used to run core services.

Some of the core services that run on this set:

* An etcd daemon
* The {product-title} API server
* The {product-title} controller

The Azure Red Hat OpenShift (ARO) sync Pod also runs on one of the master virtual machines.

[discrete]
=== ss-infra-TIMESTAMP
A scale set of three virtual machines that is used to run infrastructure Pods.

Some of the services that run on this scale set:

- The Docker registry
- Routers for applications that run on {product-title}
- The {product-title} web console
- The template service broker
- Prometheus cluster monitoring, which is used by ARO site reliability engineers to monitor cluster health

[discrete]
=== ss-compute-TIMESTAMP
A scale set of virtual machines that are used by customers' Pods. All customer
application and build Pods are scheduled on nodes within this scale set.
The customer can adjust the number of virtual machines.

[[disks]]
== Disks
All `kubernetes-dynamic-pvc-&#42;` disks are attached to their respective
virtual machine for Azure-disk-class persistent volumes (PVs).

[NOTE]
====
Persistent volumes are not backed up or replicated. You cannot use them for long-term storage.
====

[[public-ips]]
== Public IP addresses

[discrete]
=== ip-apiserver
OpenShift API and web console access. This address points to `lb-apiserver`.
Name resolution is described in xref:#dns-configuration[DNS configuration].

[discrete]
=== ip-outbound
Used for outbound traffic from customers' and infrastructure Pods.
Configured in the `kubernetes` load balancer.

[discrete]
=== kubernetes-&#42;
Used for inbound traffic to applications that run in the customers' namespace.
Configured in the `kubernetes` load balancer.

== Load Balancers
- `lb-apiserver` - See xref:#public-ips[Public IP addresses].
- `kubernetes` - For all other traffic that `lb-apiserver` does not handle:
** Connections inbound to customers' services that run on the cluster
** Connections outbound from customers' Pods

[[network-security-groups]]
== Network security groups

[discrete]
=== nsg-master
Applied to master nodes. Permits API access and SSH management access
by ARO back-end management systems.

[discrete]
=== nsg-worker
Applied to infrastructure and compute nodes. Permits access to the services that
the `kubernetes` load balancer exposes.


[[dns-configuration]]
== DNS configuration
Two DNS zones jointly compose a DNS configuration:

* `openshift.ID.REGION.azmosa.io`, a DNS name that provides API access via the *ip-apiserver*
IP address
* `&#42;.apps.ID.REGION.azmosa.io`, an alias
that, via CNAME, points to the `kubernetes-&#42;` IP address for inbound
requests to customers' services

[[key-vault]]
== Key vault
The hey vault `kv-&#42;`` stores the cluster's keys and certificates.

[[storage-accounts]]
== Storage accounts

[discrete]
=== sacfg
The account that begins with `sacfg` stores master node startup config, scale set
hashes, and etcd backups.

[discrete]
=== sareg
Docker registry storage for customers' applications.

[discrete]
=== safil
Data storage for Azure-file storage-class PVs.

[[pods]]
== Pods

A number of management Pods run in Azure Red Hat OpenShift clusters.

[discrete]
=== Sync Pod
The sync Pod runs on a single master node. Its deployment settings
ensure that one instance runs at all times.

The sync Pod's role guarantees that
managed OpenShift resources are synchronized with the desired values.

[discrete]
=== Customer admin controller
This controller synchronizes the contents of the designated Azure Active
Directory group to the cluster's RBAC customer-admin group. It also ensures
that required RBAC roles are granted in customer-created namespaces.

[discrete]
=== Monitoring related
A cluster monitoring Prometheus instance gathers monitoring data for Azure Red Hat
OpenShift site reliability engineering teams.

Customers cannot access this instance directly,
but the data it gathers is exposed via Azure Monitoring Workspaces.
