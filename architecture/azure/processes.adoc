[[architecture-azure-processes]]
= Processes
{product-author}
{product-version}
:data-uri:
:icons:
:experimental:
:toc: macro
:toc-title:
:prewrap!:

toc::[]

This section presents a summary of how Azure Red Hat OpenShift specific
processes work. These descriptions do not cover all edge cases and are
limited to presenting the expected flow. Edge case handling can be observed
in the link:https://github.com/openshift/openshift-azure[source code repository]
for Azure Red Hat OpenShift.

== Cluster update
A new release may contain new Virtual Machine images or container images.
This process is done in the background without customer involvement or any
interruption to customer applications running on the cluster.
All actions are completed by the Azure Red Hat OpenShift Resource Provider.
Decision about which components (nodes, pods) need updating is based on
comparing the current hash of a component with the desired hash value.

=== Preparation

After the resource provider switches the cluster into the appropriate
provisioning state it performs a backup of Etcd. The process continues by
generating all required configuration and template files and placing them in
their appropriate storage accounts.

=== Master updates
The master nodes are updated first. The Resource Provider checks if the current
hash of master-000000 matches the desired hash value. If the values match,
the master is skipped and not updated. If the values don't match the master is
drained, stopped, updated to the desired VM image, and started.

The process repeats with the other two masters in order, so that only a single
master is stopped at a time.

=== Infra and Compute node updates
Next the infra nodes are updated. In normal update flow a new ss-infra-&#42;
scale set is created with the new VM image configured.
The old ss-infra-&#42; scale set remains at N=3 instances.

During the update process the new scale set is extended by one instance.
After verification that the new VM has started properly and is available
the old scale set is scaled down by 1 instance. Before removing the old instance
it is drained of all pods running on it.

This cycle of adding, draining and removing repeats until the old scale set has
no instances left. The old scale set is then removed.

The Compute nodes are updated using the same process as the infra nodes,
the only difference being the node type and instance count.

=== Sync Pod update and final steps
The Sync Pod is replaced with its newer version. The Resource Provider waits for
the Sync Pod to start before persisting the final config into the storage
account and marking the cluster as updated.
