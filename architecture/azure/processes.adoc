[[azure-processes]]
= Processes
//openshift-aro 3.11 specific

This section presents the summary of how Azure Red Hat OpenShift specific
processes work. These descriptions do not go into all edge cases, and are
limited to presenting the expected flow. Edge case handling can be observed
in the source code repository for Azure Red Hat OpenShift.

== Cluster update
A new release can contain new Virtual Machine images or container images.
It is done in the background without any customer involvement or any
interruption to customer applications running on the cluster.
All actions are done by the Azure Red Hat OpenShift Resource Provider.

=== Preparation

After the resource provider switches the cluster into the appropriate
provisioning state it performs a backup of Etcd. Then generates all required
configuration and template files and places them in the appropriate storage
accounts.

=== Master updates
The master nodes are updated first. The Resource Provider checks if the current
hash of master-000000 matches the desired hash value. If it does, the node is
skipped and not updated. If it doesn't the node is drained and stopped, then
updated to the desired VM image and started.

The process repeats with the other two nodes in order, so that only one master
node is stopped at a time.

=== Infra and Compute node updates
Next the infra nodes are updated. In normal flow a new ss-infra-&#42; scale set is
created with the new VM image configured. The old ss-infra-&#42; scale set remains
at N=3 instances.

During the update process the new scale set is extended by one instance.
After verification that the new VM has started properly and is available
the old scale set is scaled down by 1 instance. Before removing the old instance
it is drained of all pods running on it.

This cycle repeats until the old scale set has no instances left.
The old scale set is then removed.

The Compute nodes are updated using the same process, the only difference being
the node type and instance count.

=== Sync Pod update and final steps
The Sync Pod is replaced with its newer version. THe Resource Provider waits for
the Sync Pod to start before persisting the final config and marking the cluster
as updated.
